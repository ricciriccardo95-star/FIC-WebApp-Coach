<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Calcolo Efficienza - Coach</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script type="module" src="auth-manager-coach.js"></script>

<style>
  /* --- Stili Generali --- */
  body { 
    font-family: 'Inter', sans-serif; 
    background-color: #0F172A; 
    color: #E2E8F0; 
    margin: 0; padding: 20px;
    -webkit-font-smoothing: antialiased;
  }

  /* --- Sfondo Animato --- */
  .background-gradient { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); filter: blur(100px); z-index: -1; }
  .gradient-1 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%); animation: pulse 10s infinite alternate; }
  .gradient-2 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%); animation: pulse 12s infinite alternate-reverse; }
  @keyframes pulse { 0% { transform: scale(0.9) rotate(0deg); } 100% { transform: scale(1.2) rotate(20deg); } }

  /* --- Layout --- */
  .page-container { max-width: 800px; margin: 40px auto 20px auto; text-align: center; }
  
  .equipaggi-container {
    background-color: rgba(15, 23, 42, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    backdrop-filter: blur(12px);
    padding: 1.5rem;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }

  h2 { font-size: 1.8rem; font-weight: 900; color: #fff; margin-bottom: 1.5rem; }

  /* --- Tasto Indietro (Freccia in alto) --- */
  .back-arrow-btn {
      position: fixed;
      top: 1.5rem;
      left: 1.5rem;
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      background-color: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      color: #E2E8F0;
      transition: all 0.2s ease;
      z-index: 50;
      backdrop-filter: blur(4px);
  }
  .back-arrow-btn:hover {
      background-color: rgba(59, 130, 246, 0.2);
      color: #fff;
      transform: translateX(-2px);
  }

  /* --- Griglia e Input --- */
  #athlete-slots-container {
      display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1.5rem;
  }
  @media (min-width: 768px) {
      #athlete-slots-container { grid-template-columns: repeat(2, 1fr); }
  }
  
  .athlete-slot {
      background-color: rgba(30, 41, 59, 0.6);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      text-align: left;
  }
  .athlete-slot h4 { margin: 0 0 0.5rem 0; color: #94A3B8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
  
  .input-group { display: flex; gap: 0.75rem; }

  /* STILE INPUT */
  select, input { 
      width: 100%; padding: 0.8rem;
      border: 1px solid #334155; border-radius: 0.5rem;
      background-color: #1E293B; color: #fff;
      font-size: 1.1rem; 
      text-align: center;
      transition: all 0.2s;
  }
  
  /* Input specifico per il tempo */
  .time-input {
      font-family: 'Courier New', monospace; 
      letter-spacing: 1px;
      font-weight: 700;
      background-color: #0f172a;
      color: #FACC15; /* Giallo */
  }
  
  select:focus, input:focus {
      outline: none; border-color: #FACC15;
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
  }
  
  /* --- Bottoni --- */
  .button-row { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; }
  .action-btn {
    border: none; border-radius: 0.5rem; padding: 1rem 2rem;
    font-size: 1rem; font-weight: 700; color: white; cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3); width: 100%; max-width: 300px;
  }
  .start { background: linear-gradient(45deg, #EAB308, #CA8A04); }
  
  /* --- Risultato --- */
  #result-container {
      margin-top: 2rem; padding: 1.5rem;
      background-color: rgba(234, 179, 8, 0.15);
      border-radius: 0.75rem; border: 1px solid rgba(234, 179, 8, 0.4);
      display: none;
  }
  #result-text { font-size: 2rem; font-weight: 800; color: #FACC15; margin: 0; }
  #details-text { margin-top: 0.5rem; font-size: 0.9rem; color: #cbd5e1; }

  /* --- Modal --- */
  .message-box {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    padding: 2rem; background-color: #1E293B; border-radius: 1rem;
    border: 1px solid #475569; z-index: 1001; display: none;
    text-align: center; width: 85%; max-width: 350px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
  }
  #messageBoxOkBtn {
      background-color: #3B82F6; color: white; border: none;
      border-radius: 0.5rem; padding: 0.75rem 2rem; font-weight: bold;
      margin-top: 1.5rem; width: 100%;
  }
</style>
</head>
<body>

<div class="background-gradient gradient-1"></div>
<div class="background-gradient gradient-2"></div>

<a href="../coach_home.html" class="back-arrow-btn" aria-label="Torna alla Home">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
</a>

<div class="page-container">
  <h2>Calcolatore Efficienza</h2>
  
  <div class="equipaggi-container">
    <div style="margin-bottom: 1.5rem;"> 
        <label for="boatTypeSelect" class="block text-slate-400 mb-2 font-medium text-sm">TIPO DI BARCA / ROW</label>
        <select id="boatTypeSelect">
            <option value="">-- Seleziona --</option>
            <option value="1X">Singolo (1X)</option>
            <option value="2X">Doppio (2X)</option>
            <option value="2-">Due Senza (2-)</option>
            <option value="4X">Quattro di Coppia (4X)</option>
            <option value="4-">Quattro Senza (4-)</option>
            <option value="8+">Otto (8+)</option>
            <option value="ROW">Rowerg (Singolo)</option>
        </select>
    </div>

    <div id="athlete-slots-container">
        <p class="text-slate-500 italic text-sm">Scegli una barca per iniziare.</p>
    </div>

    <div class="button-row">
        <button id="calculateBtn" class="action-btn start">CALCOLA</button>
    </div>

    <div id="result-container">
        <p id="result-text">0.000</p>
        <p id="details-text"></p>
    </div>
  </div>
  
  </div>

<div id="messageBox" class="message-box">
  <p id="messageText" class="text-lg text-white font-medium"></p>
  <button id="messageBoxOkBtn">OK</button>
</div>

<script>
  const crewSizes = { 
      '1X': 1, 
      '2X': 2, '2-': 2, 
      '4X': 4, '4-': 4, 
      '8+': 8,
      'ROW': 1 
  };
  
  const container = document.getElementById('athlete-slots-container');
  const resultContainer = document.getElementById('result-container');
  const resultText = document.getElementById('result-text');
  const detailsText = document.getElementById('details-text');

  // Generazione Slot
  document.getElementById('boatTypeSelect').addEventListener('change', function() {
    const type = this.value;
    container.innerHTML = ''; 
    resultContainer.style.display = 'none'; 

    if (!type) {
        container.innerHTML = '<p class="text-slate-500 italic text-sm">Scegli una barca per iniziare.</p>';
        return;
    }

    const count = crewSizes[type];

    for (let i = 1; i <= count; i++) {
        const slot = document.createElement('div');
        slot.className = 'athlete-slot';
        
        // inputmode="numeric" apre il tastierino numerico su mobile
        slot.innerHTML = `
            <h4>Atleta ${i}</h4>
            <div class="input-group">
                <div style="flex: 1;">
                    <input type="tel" inputmode="numeric" class="time-input" placeholder="mm:ss.d" maxlength="7">
                </div>
                <div style="flex: 1;">
                    <input type="tel" inputmode="decimal" class="weight-input" placeholder="Kg">
                </div>
            </div>
        `;
        container.appendChild(slot);
    }

    // Riattacca i listener per la formattazione
    attachInputListeners();
  });

  // Funzione per gestire la formattazione automatica
  function attachInputListeners() {
    
    // Gestione Tempo (formato mm:ss.d automatico)
    document.querySelectorAll('.time-input').forEach(input => {
        input.addEventListener('input', function(e) {
            // Rimuovi tutto ciò che non è un numero
            let raw = this.value.replace(/\D/g, '');
            
            // Logica di formattazione mm:ss.d
            let formatted = "";
            
            if (raw.length > 0) {
                if (raw.length <= 2) {
                    formatted = raw;
                    // Se l'utente scrive 62, probabilmente intende 6:2... ma aspettiamo un attimo o formattiamo subito?
                    // Per UX fluida:
                    if(raw.length === 2 && parseInt(raw) > 15) { // Se > 15 probabilmente sono secondi (es. 20) o mm
                        // Lasciamo raw
                    }
                } else if (raw.length === 3) {
                     // 620 -> 6:20
                     formatted = raw.slice(0, 1) + ":" + raw.slice(1);
                } else if (raw.length === 4) {
                     // 6205 -> 6:20.5
                     formatted = raw.slice(0, 1) + ":" + raw.slice(1, 3) + "." + raw.slice(3);
                } else if (raw.length >= 5) {
                     // 16205 -> 16:20.5
                     const last3 = raw.slice(-3);
                     const mins = raw.slice(0, -3);
                     formatted = mins + ":" + last3.slice(0, 2) + "." + last3.slice(2);
                } else {
                    formatted = raw;
                }
            }
            
            // Applichiamo solo se abbiamo una formattazione valida
            if (formatted) {
                this.value = formatted;
            }
        });
    });
  }

  // Logica Calcolo
  document.getElementById('calculateBtn').addEventListener('click', function() {
    const timeInputs = document.querySelectorAll('.time-input');
    const weightInputs = document.querySelectorAll('.weight-input');

    if (timeInputs.length === 0) {
        showMessage("Seleziona prima il tipo di barca.");
        return;
    }

    let totalEfficiency = 0;
    let validAthletes = 0;

    for (let i = 0; i < timeInputs.length; i++) {
        const timeStr = timeInputs[i].value.trim();
        const weightVal = parseFloat(weightInputs[i].value.replace(',', '.'));

        if (!timeStr || isNaN(weightVal)) {
            showMessage(`Compila tutti i campi per l'Atleta ${i+1}.`);
            return;
        }

        const seconds = parseTime(timeStr);
        if (!seconds) {
            showMessage(`Tempo Atleta ${i+1} non valido. Usa il formato mm:ss.d`);
            return;
        }

        const velocity = 2000 / seconds;
        const power = 2.8 * Math.pow(velocity, 3);
        const efficiency = power / (weightVal + 15);

        totalEfficiency += efficiency;
        validAthletes++;
    }

    if (validAthletes > 0) {
        const avgEff = totalEfficiency / validAthletes;
        resultText.textContent = `Eff: ${avgEff.toFixed(3)}`;
        detailsText.textContent = `Media su ${validAthletes} atleti`;
        resultContainer.style.display = 'block';
    }
  });

  function parseTime(str) {
      if (!str.includes(':')) {
          // Fallback se l'utente ha cancellato i due punti manualmente
          if(str.length >= 3 && !isNaN(str)) {
             // Tenta di interpretare raw number
             // Non facciamo nulla di complesso, ritorniamo null per sicurezza
             return null;
          }
          return null; 
      }

      const parts = str.split(':');
      const min = parseInt(parts[0]);
      const secPart = parseFloat(parts[1]);
      
      if (isNaN(min) || isNaN(secPart)) return null;
      
      return (min * 60) + secPart;
  }

  function showMessage(msg) {
      document.getElementById('messageText').textContent = msg;
      document.getElementById('messageBox').style.display = 'block';
  }
  
  document.getElementById('messageBoxOkBtn').addEventListener('click', () => {
      document.getElementById('messageBox').style.display = 'none';
  });

</script>

</body>
</html>
