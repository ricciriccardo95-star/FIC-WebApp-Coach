<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Allenamenti - FIC Canottaggio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/heroicons"></script>
    <style>
        /* Stili di base */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617;
            color: #E2E8F0; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        .background-gradient { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            filter: blur(150px);
            opacity: 0.4;
            z-index: -1; 
        }
        .gradient-1 { 
            width: 600px; 
            height: 600px; 
            background: radial-gradient(circle, rgba(37, 99, 235, 0.4), transparent 70%);
            animation: pulse 10s infinite alternate; 
        }
        .gradient-2 { 
            width: 500px; 
            height: 500px; 
            background: radial-gradient(circle, rgba(168, 85, 247, 0.3), transparent 70%);
            animation: pulse 12s infinite alternate-reverse; 
            top: 60%;
            left: 40%;
        }
        @keyframes pulse { 
            0% { transform: translate(-50%, -50%) scale(0.9) rotate(0deg); } 
            100% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); } 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        .loader { 
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite; 
        }
        
        /* Stili per select */
        .filter-select { 
            background-color: #1E293B; 
            border: 1px solid #334155; 
            border-radius: 0.5rem; 
            padding: 0.5rem 1rem; 
            color: #E2E8F0; 
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .filter-select { 
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%2394A3B8"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
            padding-right: 2.5rem; /* Spazio per la freccia */
        }
        
        .filter-select:focus {
            border-color: #3B82F6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Stili tabella */
        table { border-collapse: collapse; }
        th, td { padding: 0.75rem 0.6rem; text-align: left; }
        th { background-color: #334155; font-weight: 700; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:nth-child(even) { background-color: #1e293b; }
        tr:nth-child(odd) { background-color: #162031; }
        tr:hover { background-color: #374764; }
        td { border-bottom: 1px solid #334155; white-space: nowrap; }
        .rank-1 { color: #facc15; font-weight: 900; }
        .rank-2 { color: #d1d5db; font-weight: 900; }
        .rank-3 { color: #cd7f32; font-weight: 900; }
        .ep-value { font-size: 0.8rem; font-weight: 700; color: #fbbf24; }
        .vol-value { font-size: 0.8rem; font-weight: 700; color: #22c55e; }
        .ep-col-min { min-width: 70px; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; line-height: 1.2; text-align: center; white-space: nowrap; vertical-align: baseline; }

        /* Stili responsive */
        @media screen and (max-width: 768px) {
            table { width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; }
            table thead { display: none; } 
            table tbody { display: block; width: 100%; }
            table tr { display: block; border-radius: 0.75rem; background-color: #1e293b; border: 1px solid #334155; padding: 0; width: 100%; overflow: hidden; }
            table tr:nth-child(even), table tr:nth-child(odd) { background-color: #1e293b; }
            table tr:hover { background-color: #2b3b57; }
            .mobile-row-summary { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; text-align: left; width: 100%; margin: 0 auto; gap: 0.5rem; border-radius: 0.75rem; }
            .mobile-main-info { display: flex; flex-direction: column; flex-grow: 1; min-width: 0; }
            .mobile-row-line1 { display: flex; align-items: baseline; gap: 0.5rem; width: 100%; }
            .mobile-rank-number { font-size: 1.25rem; font-weight: 700; flex-shrink: 0; }
            .mobile-athlete-name { font-size: 1.1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
            .mobile-group-badge .badge { font-size: 0.65rem; padding: 0.1rem 0.4rem; flex-shrink: 0; }
            .mobile-row-line2 { display: flex; flex-direction: column; align-items: flex-start; margin-top: 0.25rem; }
            .mobile-score-label { font-size: 0.65rem; font-weight: 500; color: #94A3B8; text-transform: uppercase; margin-bottom: -4px; }
            .mobile-score-value { font-size: 1.5rem; font-weight: 900; background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #60A5FA, #7DD3FC); }
            .mobile-arrow-icon { display: flex; align-items: center; justify-content: flex-end; transition: transform 0.2s ease-in-out; flex-shrink: 0; }
            .mobile-details { display: none; padding: 0.5rem 1rem 1rem 1rem; background-color: #0f172a; border-top: 1px solid #334155; }
            .mobile-details.active { display: block; }
            .mobile-details-item { display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; font-size: 0.9em; color: #cbd5e1; }
            .mobile-details-item span:first-child { font-weight: 600; color: #94A3B8; }
            .mobile-details-item .ep-value,
            .mobile-details-item .vol-value { font-size: 0.9em; }
        }
        .rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="antialiased">
    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div id="loader-overlay" class="fixed inset-0 bg-slate-950/90 flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <div class="loader h-16 w-16 animate-spin rounded-full border-4 border-t-4 border-slate-600"></div>
        <p id="loader-text" class="mt-4 text-slate-300 font-medium">Caricamento dati...</p>
    </div>

    <div id="app-view" class="pt-4 pb-4 md:p-10 max-w-screen-2xl mx-auto relative z-10 hidden">
        
        <!-- Tasto Home -->
        <a href="../index.html" class="absolute top-4 left-4 md:top-6 md:left-6 inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg shadow transition-colors text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 19l-7-7 7-7"/><path d="M19 12H5"/></svg>
            Home
        </a>

        <h1 class="text-4xl md:text-6xl font-extrabold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-sky-300 text-center mb-6 pt-4">
            Ranking
        </h1>
        
        <!-- === SELETTORI RANKING (NUOVA VERSIONE) === -->
        <div class="bg-slate-900/80 border border-slate-700/60 rounded-xl shadow-2xl p-6 mb-8 flex flex-col md:flex-row justify-center items-center gap-6 mx-4 md:mx-0">
            
            <!-- Bottone Totale -->
            <div class="text-center">
                <button id="loadTotalBtn" class="bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-blue-500/50 text-lg">
                    Ranking Totale
                </button>
                <p class="text-xs text-slate-400 mt-2">
                    (i) Classifica di tutti gli allenamenti (agg. alle 03:00)
                </p>
            </div>
            
            <!-- Bottone Mese Corrente -->
            <div class="text-center">
                <button id="loadMonthlyBtn" class="bg-teal-600 hover:bg-teal-500 active:bg-teal-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-teal-500/50 text-lg">
                    Ranking Mese Corrente
                </button>
                <p class="text-xs text-slate-400 mt-2">
                    (i) Riepilogo del mese corrente (agg. alle 02:00)
                </p>
            </div>
        </div>
        <!-- === FINE SELETTORI === -->

        <!-- === FILTRI === -->
        <div id="filter-controls" class="bg-slate-900/80 border border-slate-700/60 rounded-xl shadow-xl p-4 mb-8 flex flex-col md:flex-row justify-center items-center gap-4 mx-4 md:mx-0 hidden">
            <div class_="w-full md:w-1/3">
                <label for="filterGenere" class="text-slate-400 font-semibold mb-1 block text-sm">Filtra per Genere</label>
                <select id="filterGenere" class="filter-select">
                    <option value="">Tutti i Generi</option>
                    <option value="M">Maschile</option>
                    <option value="F">Femminile</option>
                </select>
            </div>
            <div class="w-full md:w-1/3">
                <label for="filterGruppo" class="text-slate-400 font-semibold mb-1 block text-sm">Filtra per Gruppo</label>
                <select id="filterGruppo" class="filter-select">
                    <option value="">Tutti i Gruppi</option>
                    <option value="Squadra olimpica">Squadra olimpica</option>
                    <option value="Under 23">Under 23</option>
                    <option value="Under 19">Under 19</option>
                    <option value="ParaRowing">ParaRowing</option>
                    <option value="Beach sprint">Beach sprint</option>
                </select>
            </div>
        </div>
        <!-- === FINE FILTRI === -->


        <div id="results-container" class="mx-4 md:mx-0">
            <!-- La tabella verrà inserita qui --></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            // TUA CONFIGURAZIONE FIREBASE
            apiKey: "AIzaSyAQ_0F8KCks_4Wn2h2aTIepQY9VrIkWpUQ", authDomain: "database-atleti-fic.firebaseapp.com",
            databaseURL: "https://database-atleti-fic-default-rtdb.firebaseio.com", projectId: "database-atleti-fic",
            storageBucket: "database-atleti-fic.firebasestorage.app", messagingSenderId: "860422140545",
            appId: "1:860422140545:web:cd14c042a47f2650681380"
        };
        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();

        // Riferimenti DOM
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const resultsContainer = document.getElementById('results-container');
        const loadMonthlyBtn = document.getElementById('loadMonthlyBtn');
        const loadTotalBtn = document.getElementById('loadTotalBtn'); // NUOVO
        const appView = document.getElementById('app-view');
        
        // Riferimenti Filtri
        const filterControls = document.getElementById('filter-controls');
        const filterGenere = document.getElementById('filterGenere');
        const filterGruppo = document.getElementById('filterGruppo');

        // Variabile globale per memorizzare i dati scaricati
        let allAthletesData = [];

        // --- FUNZIONI HELPER ---
        function getCurrentMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        // --- FUNZIONE PER I BADGE (GRUPPO) ---
        function getGruppoBadge(value) {
            if (!value) return '<span class="badge bg-slate-600 text-slate-200" title="Non Definito">N/D</span>';
            let bgColor = 'bg-slate-600', textColor = 'text-slate-200', abbrev = 'N/D';
            switch (value) {
                case 'Squadra olimpica': bgColor = 'bg-sky-500'; textColor = 'text-white'; abbrev = 'GO'; break;
                case 'Under 23': bgColor = 'bg-teal-500'; textColor = 'text-white'; abbrev = 'U23'; break;
                case 'Under 19': bgColor = 'bg-orange-500'; textColor = 'text-white'; abbrev = 'U19'; break;
                case 'ParaRowing': bgColor = 'bg-purple-500'; textColor = 'text-white'; abbrev = 'PR'; break;
                case 'Beach sprint': bgColor = 'bg-amber-500'; textColor = 'text-white'; abbrev = 'BS'; break;
            }
            return `<span class="badge ${bgColor} ${textColor}" title="${value}">${abbrev}</span>`;
        }

        // --- FUNZIONE BADGE (GENERE) ---
        function getGenereBadge(value) {
            if (!value) return '<span class="badge bg-slate-600 text-slate-200" title="Non Definito">N/D</span>';
            let bgColor = 'bg-slate-600', textColor = 'text-slate-200', text = value;
            
            if (value === 'M') { bgColor = 'bg-blue-500'; textColor = 'text-white'; } 
            else if (value === 'F') { bgColor = 'bg-pink-500'; textColor = 'text-white'; }
            
            return `<span class="badge ${bgColor} ${textColor}" title="${value}">${text}</span>`;
        }

        // --- FUNZIONE PER FILTRARE E RENDERIZZARE ---
        function applyFiltersAndRender() {
            const selectedGenere = filterGenere.value;
            const selectedGruppo = filterGruppo.value;

            // Filtra i dati
            let filteredAthletes = allAthletesData;

            if (selectedGenere) {
                filteredAthletes = filteredAthletes.filter(athlete => athlete.genere === selectedGenere);
            }

            if (selectedGruppo) {
                filteredAthletes = filteredAthletes.filter(athlete => athlete.gruppo === selectedGruppo);
            }

            // Chiama la funzione di render con i dati filtrati
            renderRanking(filteredAthletes);
        }


        // --- NUOVA FUNZIONE - Carica Dati TOTALI ---
        async function loadTotalData() {
            loaderText.textContent = 'Caricamento ranking totale...';
            loaderOverlay.style.display = 'flex';
            resultsContainer.innerHTML = '';
            filterControls.classList.add('hidden'); // Nasconde i filtri
            allAthletesData = []; // Resetta i dati

            try {
                const docRef = firestore.doc(`rankingTotale/overall`);
                const doc = await docRef.get(); // <-- 1 LETTURA

                if (doc.exists) {
                    const data = doc.data();
                    allAthletesData = data.ranking || []; // Salva i dati nella variabile globale
                    applyFiltersAndRender(); // Filtra e renderizza
                    filterControls.classList.remove('hidden'); // Mostra i filtri
                } else {
                    resultsContainer.innerHTML = `<p class="text-center text-yellow-400 p-8 text-xl font-medium">Documento ranking totale non ancora disponibile.<br/>(Viene generato ogni notte alle 03:00)</p>`;
                }
            } catch (error) {
                console.error("Errore nel caricamento del ranking totale: ", error);
                resultsContainer.innerHTML = `<p class="p-8 bg-red-900/40 border-2 border-red-700 rounded-xl text-red-200 shadow-xl">⚠️ ERRORE: Impossibile caricare il ranking totale.</p>`;
            } finally {
                loaderOverlay.style.display = 'none';
            }
        }
        
        // --- FUNZIONE (MODIFICATA) - Carica Dati MENSILI ---
        async function loadMonthlyData() {
            loaderText.textContent = 'Caricamento ranking del mese...';
            loaderOverlay.style.display = 'flex';
            resultsContainer.innerHTML = '';
            filterControls.classList.add('hidden'); // Nasconde i filtri
            allAthletesData = []; // Resetta i dati

            // Calcola automaticamente il mese corrente
            const monthId = getCurrentMonthString(); 
            
            try {
                const docRef = firestore.doc(`riepiloghiMensili/${monthId}`);
                const doc = await docRef.get(); // <-- 1 LETTURA

                if (doc.exists) {
                    const data = doc.data();
                    allAthletesData = data.ranking || []; // Salva i dati nella variabile globale
                    applyFiltersAndRender(); // Filtra e renderizza
                    filterControls.classList.remove('hidden'); // Mostra i filtri
                } else {
                    resultsContainer.innerHTML = `<p class="text-center text-yellow-400 p-8 text-xl font-medium">Riepilogo mensile per ${monthId} non ancora disponibile.<br/>(Viene generato ogni notte alle 02:00)</p>`;
                }
            } catch (error) {
                console.error("Errore nel caricamento del ranking mensile: ", error);
                resultsContainer.innerHTML = `<p class="p-8 bg-red-900/40 border-2 border-red-700 rounded-xl text-red-200 shadow-xl">⚠️ ERRORE: Impossibile caricare il ranking mensile.</p>`;
            } finally {
                loaderOverlay.style.display = 'none';
            }
        }


        // --- FUNZIONE DI RENDER (INVARIATA) ---
        function renderRanking(rankedAthletes) {
            if (!rankedAthletes || rankedAthletes.length === 0) {
                // Modifica messaggio se i dati master ci sono ma i filtri non danno risultati
                if (allAthletesData.length > 0) {
                    resultsContainer.innerHTML = `<p class="text-center text-slate-400 p-8 text-xl">Nessun atleta trovato con i filtri selezionati.</p>`;
                } else {
                    resultsContainer.innerHTML = `<p class="text-center text-slate-400 p-8 text-xl">Nessun dato trovato.</p>`;
                }
                return;
            }

            const table = document.createElement('table');
            table.className = "w-full text-white md:rounded-xl md:overflow-hidden md:bg-slate-900/80 md:border md:border-slate-700/60 md:shadow-2xl"; 
            table.innerHTML = `
                <thead class="hidden md:table-header-group">
                    <tr>
                        <th scope="col" class="w-16 text-center">#</th>
                        <th scope="col">Atleta</th>
                        <th scope="col">Gruppo</th>
                        <th scope="col">Genere</th> 
                        
                        <th scope="col" class="text-right">Barca (Metri)</th>
                        <th scope="col" class="text-right ep-col-min">EP Barca</th>
                        <th scope="col" class="text-right">Ergo (Metri)</th>
                        <th scope="col" class="text-right ep-col-min">EP Ergo</th>
                        <th scope="col" class="text-right">Bike (Metri)</th>
                        <th scope="col" class="text-right ep-col-min">EP Bike</th>

                        <th scope="col" class="text-right ep-col-min">Vol Barca</th>
                        <th scope="col" class="text-right ep-col-min">Vol Ergo</th>
                        <th scope="col" class="text-right ep-col-min">Vol Bike</th>

                        <th scope="col" class="text-right">Punteggio Tot.</th>
                    </tr>
                </thead>
                <tbody class="block md:table-row-group">
                    ${rankedAthletes.map((athlete, index) => {
                        const relativeRank = index + 1;
                        
                        let rankClass = '';
                        if (index === 0) rankClass = 'rank-1';
                        if (index === 1) rankClass = 'rank-2';
                        if (index === 2) rankClass = 'rank-3';

                        const boatMeters = (athlete.boat && athlete.boat.meters) ? athlete.boat.meters : 0;
                        const boatEp = (athlete.avgBoatEp) ? athlete.avgBoatEp : 0;
                        const ergoMeters = (athlete.ergo && athlete.ergo.meters) ? athlete.ergo.meters : 0;
                        const ergoEp = (athlete.avgErgoEp) ? athlete.avgErgoEp : 0;
                        const bikeMeters = (athlete.bike && athlete.bike.meters) ? athlete.bike.meters : 0;
                        const bikeEp = (athlete.avgBikeEp) ? athlete.avgBikeEp : 0;

                        const format = (num) => (num || 0).toLocaleString('it-IT', { maximumFractionDigits: 0 });
                        const formatScore = (num) => (num || 0).toLocaleString('it-IT', { maximumFractionDigits: 2 });
                        const formatEp = (num) => (num && num > 0) ? `${num.toFixed(2)}%` : '-';
                        
                        const gruppoBadge = getGruppoBadge(athlete.gruppo);
                        const genereBadge = getGenereBadge(athlete.genere);

                        return `
                        <tr id="athlete-row-${athlete.id || index}" class="block md:table-row">
                            <!-- DESKTOP VIEW -->
                            <td data-label="#" class="hidden md:table-cell text-center font-bold text-xl rank-cell ${rankClass}">${relativeRank}</td>
                            <td data-label="Atleta" class="hidden md:table-cell font-bold text-lg athlete-cell">${athlete.name}</td>
                            <td data-label="Gruppo" class="hidden md:table-cell">${gruppoBadge}</td>
                            <td data-label="Genere" class="hidden md:table-cell">${genereBadge}</td>
                            <td data-label="Barca (Metri)" class="hidden md:table-cell text-right text-emerald-300">${format(boatMeters)}</td>
                            <td data-label="EP Barca" class="hidden md:table-cell text-right ep-col-min ep-value">${formatEp(boatEp)}</td>
                            <td data-label="Ergo (Metri)" class="hidden md:table-cell text-right text-sky-300">${format(ergoMeters)}</td>
                            <td data-label="EP Ergo" class="hidden md:table-cell text-right ep-col-min ep-value">${formatEp(ergoEp)}</td>
                            <td data-label="Bike (Metri)" class="hidden md:table-cell text-right text-purple-300">${format(bikeMeters)}</td>
                            <td data-label="EP Bike" class="hidden md:table-cell text-right ep-col-min ep-value">${formatEp(bikeEp)}</td>
                            <td data-label="Vol Barca" class="hidden md:table-cell text-right ep-col-min vol-value">${formatScore(athlete.volBarca)}%</td>
                            <td data-label="Vol Ergo" class="hidden md:table-cell text-right ep-col-min vol-value">${formatScore(athlete.volErgo)}%</td>
                            <td data-label="Vol Bike" class="hidden md:table-cell text-right ep-col-min vol-value">${formatScore(athlete.volBike)}%</td>
                            <td data-label="Punteggio Tot." class="hidden md:table-cell text-right font-extrabold text-xl text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-sky-300">${formatScore(athlete.score)}</td>

                            <!-- MOBILE VIEW -->
                            <td colspan="14" class="md:hidden p-0 border-b-0">
                                <div class="mobile-row-summary" data-athlete-id="${athlete.id || index}">
                                    <div class="mobile-main-info">
                                        <div class="mobile-row-line1">
                                            <span class="mobile-rank-number ${rankClass}">${relativeRank}.</span>
                                            <span class="mobile-athlete-name">${athlete.name}</span>
                                            <span class="mobile-group-badge">${gruppoBadge}</span>
                                            <span class="mobile-group-badge">${genereBadge}</span>
                                        </div>
                                        <div class="mobile-row-line2">
                                            <span class="mobile-score-label">Punteggio</span>
                                            <span class="mobile-score-value">${formatScore(athlete.score)}</span>
                                        </div>
                                    </div>
                                    <div class="mobile-arrow-icon">
                                        <svg class="h-6 w-6 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                                
                                <div class="mobile-details" id="details-${athlete.id || index}">
                                    <div class="mobile-details-item"><span>Genere</span> <span>${genereBadge}</span></div>
                                    <div class="mobile-details-item"><span>Barca (Metri)</span> <span class="text-emerald-300">${format(boatMeters)}</span></div>
                                    <div class="mobile-details-item"><span>EP Barca</span> <span class="ep-value">${formatEp(boatEp)}</span></div>
                                    <div class="mobile-details-item"><span>Ergo (Metri)</span> <span class="text-sky-300">${format(ergoMeters)}</span></div>
                                    <div class="mobile-details-item"><span>EP Ergo</span> <span class="ep-value">${formatEp(ergoEp)}</span></div>
                                    <div class="mobile-details-item"><span>Bike (Metri)</span> <span class="text-purple-300">${format(bikeMeters)}</span></div>
                                    <div class="mobile-details-item"><span>EP Bike</span> <span class="ep-value">${formatEp(bikeEp)}</span></div>
                                    <div class="mobile-details-item"><span>Vol Barca</span> <span class="vol-value">${formatScore(athlete.volBarca)}%</span></div>
                                    <div class="mobile-details-item"><span>Vol Ergo</span> <span class="vol-value">${formatScore(athlete.volErgo)}%</span></div>
                                    <div class="mobile-details-item"><span>Vol Bike</span> <span class="vol-value">${formatScore(athlete.volBike)}%</span></div>
                                </div>
                            </td>
                        </tr>
                        `
                    }).join('')}
                </tbody>
            `;
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(table);

            // Aggiungi event listeners per i dettagli mobile
            document.querySelectorAll('.mobile-row-summary').forEach(row => {
                row.addEventListener('click', (event) => {
                    const athleteId = row.dataset.athleteId;
                    const detailsDiv = document.getElementById(`details-${athleteId}`);
                    const arrowIcon = row.querySelector('.mobile-arrow-icon');
                    
                    if (detailsDiv && arrowIcon) {
                        detailsDiv.classList.toggle('active');
                        arrowIcon.classList.toggle('rotate-180');
                    }
                });
            });
        }

        // --- GESTIONE AVVIO PAGINA (MODIFICATO) ---
        document.addEventListener('DOMContentLoaded', async () => { 
            loaderText.textContent = 'Caricamento...';
            appView.classList.remove('hidden');
            
            // Collega i bottoni alle rispettIVE funzioni
            loadTotalBtn.addEventListener('click', loadTotalData);
            loadMonthlyBtn.addEventListener('click', loadMonthlyData);
            
            // LISTENER PER I FILTRI
            filterGenere.addEventListener('change', applyFiltersAndRender);
            filterGruppo.addEventListener('change', applyFiltersAndRender);

            // Carica automaticamente il ranking TOTALE all'avvio
            await loadTotalData(); 
        });
    </script>
</body>
</html>
