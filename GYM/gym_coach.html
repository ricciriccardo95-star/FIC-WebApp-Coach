<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <!-- Il charset era 'UTF-R', l'ho corretto in 'UTF-8' -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym - Coach View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        .plan-card summary { cursor: pointer; outline: none; }
        .plan-card[open] summary { border-bottom: 1px solid #334155; }
        .plan-card summary::-webkit-details-marker { display: none; }
        .plan-card summary .icon { transition: transform 0.2s; }
        .plan-card[open] summary .icon { transform: rotate(90deg); }
        #image-lightbox { transition: opacity 0.3s ease; }
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; font-weight: 600; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: #e2e8f0; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
     <!-- 
        MODIFICA:
        1. Aggiunto auth-manager-coach.js (con percorso ../)
     -->
     <script type="module" src="../auth-manager-coach.js"></script>
</head>
<body class="antialiased" style="visibility: hidden;">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div id="loader-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col justify-center items-center z-50">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-t-4 border-slate-600 border-t-sky-500"></div>
        <p class="mt-4 text-slate-300">Caricamento dati...</p>
    </div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <header class="mb-10 border-b border-slate-700 pb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black text-slate-100">Gym Coach</h1>
                    <p id="welcome-message" class="text-lg text-sky-400 font-semibold">Visualizzazione Schede e Circuiti</p>
                </div>
                <!-- Percorso corretto per tornare alla home -->
                <a href="../coach_home.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    Home
                </a>
            </div>
        </header>

        <main id="main-content" class="hidden">
            <!-- Tabs -->
            <div class="mb-6 flex border-b border-slate-700">
                <button id="tab-btn-schede" class="tab-btn active" data-tab="schede">Schede</button>
                <button id="tab-btn-circuiti" class="tab-btn" data-tab="circuiti">Circuiti</button>
            </div>

            <!-- Contenuto Tab Schede -->
            <div id="schede-content" class="tab-content active">
                <h2 class="text-2xl font-bold text-white mb-6">Schede di Allenamento</h2>
                <div id="plans-container" class="space-y-6"></div>
                <div id="no-schede-message" class="hidden text-center py-16 px-6 bg-slate-900/70 border border-slate-700/50 rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-slate-500"><rect x="3" y="10" width="4" height="4" rx="1"/><rect x="17" y="10" width="4" height="4" rx="1"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
                    <h3 class="text-xl font-bold text-white">Nessuna scheda trovata</h3>
                    <p class="text-slate-400 mt-2">Non ci sono ancora schede di allenamento disponibili.</p>
                </div>
            </div>

            <!-- Contenuto Tab Circuiti -->
            <div id="circuiti-content" class="tab-content">
                <h2 class="text-2xl font-bold text-white mb-6">Circuiti</h2>
                <div id="circuits-container" class="space-y-6"></div>
                <div id="no-circuits-message" class="hidden text-center py-16 px-6 bg-slate-900/70 border border-slate-700/50 rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-slate-500"><path d="M12 2.8c.9-.1 1.8.2 2.5.8 1.1 1 1.5 2.5 1 4L12 18 8.5 7.5c-.5-1.4 0-3 1-4 .8-.5 1.7-.8 2.5-.7z"/><path d="M12 18c-1.9 0-3.5-1-4.5-2.5s-1.5-3.5-1-5.5c.3-1.1.8-2.1 1.5-3M12 18c1.9 0 3.5-1 4.5-2.5s1.5-3.5 1-5.5c-.3-1.1-.8-2.1-1.5-3"/></svg>
                    <h3 class="text-xl font-bold text-white">Nessun circuito trovato</h3>
                    <p class="text-slate-400 mt-2">Non ci sono ancora circuiti disponibili.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Image Lightbox Modal (invariato) -->
    <div id="image-lightbox" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 opacity-0">
        <div class="relative max-w-3xl max-h-full">
            <img id="lightbox-image" src="" alt="Esercizio ingrandito" class="block max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl">
            <button id="close-lightbox" class="absolute -top-2 -right-2 bg-white text-slate-900 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xl leading-none">&times;</button>
        </div>
    </div>

    <script type="module">
        // --- MODIFICA: Rimossa logica di autenticazione ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Rimosso: getAuth, onAuthStateChanged
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Rimosso: authFirebaseConfig, appAuth, auth

        // Config per il DATABASE (progetto 'calendario-fic')
        const dbFirebaseConfig = {
            apiKey: "AIzaSyAylHKH-9PROLRz4CGYDCN8Tggdj3_CGSI",
            authDomain: "calendario-fic.firebaseapp.com",
            projectId: "calendario-fic",
            storageBucket: "calendario-fic.appspot.com",
            messagingSenderId: "576407223567",
            appId: "1:576407223567:web:73eaa8e12aae9e4926927a"
        };
        
        // Inizializza l'app del DB (l'unica necessaria qui)
        const appDb = initializeApp(dbFirebaseConfig, "AppDb");
        const db = getFirestore(appDb); // Il DB è quello di 'calendario-fic'
        // --- FINE BLOCCO CONFIG MODIFICATO ---


        const loader = document.getElementById('loader-overlay');
        const mainContent = document.getElementById('main-content');
        const welcomeMessage = document.getElementById('welcome-message');
        const plansContainer = document.getElementById('plans-container');
        const noSchedeMessage = document.getElementById('no-schede-message');
        const imageLightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const closeLightboxBtn = document.getElementById('close-lightbox');
        
        const tabBtnSchede = document.getElementById('tab-btn-schede');
        const tabBtnCircuiti = document.getElementById('tab-btn-circuiti');
        const schedeContent = document.getElementById('schede-content');
        const circuitiContent = document.getElementById('circuiti-content');
        const circuitsContainer = document.getElementById('circuits-container');
        const noCircuitsMessage = document.getElementById('no-circuits-message');

        
        // --- MODIFICA: Sostituito onAuthStateChanged con listener per 'coachAuthStateReady' ---
        document.addEventListener('coachAuthStateReady', (e) => {
            const { coach, error } = e.detail;

            if (coach) {
                // Utente loggato, mostra la pagina e carica i dati
                document.body.style.visibility = 'visible';
                welcomeMessage.textContent = `Benvenuto, ${coach.cognome || 'Coach'}`;
                loadGymData(); // Avvia il caricamento dei dati
            } else {
                // Non loggato o errore, auth-manager-coach.js gestirà il redirect.
                // Non è necessario fare nulla qui, il body rimane 'hidden'.
                console.log("Auth fallita, redirect in corso...");
            }
        });
        
        // Funzione loadGymData (invariata, ora chiamata dal listener)
        async function loadGymData() {
            try {
                // 1. I massimali non servono più per la vista coach
                const massimaliMap = new Map(); // Mappa vuota

                // 2. Carica la libreria di tutti gli esercizi
                const eserciziMap = new Map();
                const eserciziQuery = query(collection(db, "esercizi_pesistica"));
                const eserciziSnapshot = await getDocs(eserciziQuery);
                eserciziSnapshot.forEach(doc => {
                    eserciziMap.set(doc.id, doc.data());
                });

                // 3. Carica tutte le schede E I CIRCUITI
                const schedeQuery = query(collection(db, "schede_pesistica"));
                const circuitiQuery = query(collection(db, "circuiti_pesistica"));

                const [schedeSnapshot, circuitiSnapshot] = await Promise.all([
                    getDocs(schedeQuery),
                    getDocs(circuitiQuery)
                ]);

                // 4. Processa le schede
                if (schedeSnapshot.empty) {
                    noSchedeMessage.classList.remove('hidden');
                } else {
                    plansContainer.innerHTML = '';
                    const schede = schedeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    schede.sort((a, b) => a.nomeScheda.localeCompare(b.nomeScheda));
                    
                    schede.forEach(scheda => {
                        // Passa la mappa vuota, non farà calcoli
                        const planElement = createPlanElement(scheda, massimaliMap, eserciziMap);
                        plansContainer.appendChild(planElement);
                    });
                    noSchedeMessage.classList.add('hidden');
                }

                // 5. Processa i circuiti
                if (circuitiSnapshot.empty) {
                    noCircuitsMessage.classList.remove('hidden');
                } else {
                    circuitsContainer.innerHTML = '';
                    const circuiti = circuitiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    circuiti.sort((a, b) => a.nomeCircuito.localeCompare(b.nomeCircuito));
                    
                    circuiti.forEach(circuito => {
                        const circuitElement = createCircuitElement(circuito, eserciziMap);
                        circuitsContainer.appendChild(circuitElement);
                    });
                    noCircuitsMessage.classList.add('hidden');
                }

            } catch (error) {
                console.error("Errore nel caricamento dei dati: ", error);
                plansContainer.innerHTML = `<p class="text-red-400 text-center">Impossibile caricare i dati. Riprova più tardi.</p>`;
                circuitsContainer.innerHTML = `<p class="text-red-400 text-center">Impossibile caricare i dati. Riprova più tardi.</p>`;
            } finally {
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        // --- Funzione createPlanElement (invariata) ---
        function createPlanElement(scheda, massimaliMap, eserciziMap) {
            const details = document.createElement('details');
            details.className = 'plan-card bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg overflow-hidden';
            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-4 md:p-6';
            summary.innerHTML = `
                <h3 class="text-xl font-bold text-white">${scheda.nomeScheda}</h3>
                <div class="icon text-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            `;
            const content = document.createElement('div');
            content.className = 'p-4 md:p-6 border-t border-slate-700/50';
            const exerciseList = document.createElement('div');
            exerciseList.className = 'space-y-4';

            if (scheda.esercizi && scheda.esercizi.length > 0) {
                 const orderedExercises = (scheda.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                orderedExercises.forEach(esercizio => {
                    if (!esercizio.esercizioId) return; // Salta se manca id
                    const fullEsercizio = eserciziMap.get(esercizio.esercizioId);
                    const imageUrl = fullEsercizio?.imageUrl || 'https://placehold.co/100x100/334155/e2e8f0?text=IMG';
                    const nomeEsercizio = esercizio.nome || fullEsercizio?.nome || 'Esercizio Sconosciuto';
                    const notaGeneraleEsercizio = fullEsercizio?.note || '';
                    const tipoSerie = esercizio.tipo || 'fisse';
                    const infoHtml = `
                        <p class="font-bold text-lg text-slate-100">${nomeEsercizio}</p>
                        ${notaGeneraleEsercizio ? `<p class="text-sm text-slate-400 italic mt-1">${notaGeneraleEsercizio}</p>` : ''}
                        <p class="text-sm font-medium text-indigo-300 mt-2">Tipo: <span class="font-normal capitalize text-slate-300">${tipoSerie}</span></p>
                    `;
                    let setsHtml = '<div class="space-y-3 mt-3">';
                    if (esercizio.sets && esercizio.sets.length > 0) {
                        esercizio.sets.forEach(set => {
                            const percentuale = set.percentuale || '-';
                            const setNoteHtml = set.note ? `<p class="text-xs text-amber-300/80 mt-1 italic pl-2">Nota: ${set.note}</p>` : '';
                            setsHtml += `
                                <div class="bg-slate-700/50 p-3 rounded-lg">
                                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                        <p class="text-slate-300 font-mono text-sm">
                                            <span class="font-bold text-white">${set.serie || '-'}</span> x <span class="font-bold text-white">${set.ripetizioni || '-'}</span>
                                        </p>
                                        <div class="flex items-center gap-2 bg-slate-800 p-2 rounded-lg flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12v0Z"></path><path d="M12 13.4a1.4 1.4 0 1 0 0-2.8 1.4 1.4 0 0 0 0 2.8Z"></path><path d="M12 4.1v-2.9"></path><path d="M12 22.8v-2.9"></path><path d="m17 7-2-2"></path><path d="m7 17 2 2"></path><path d="M4.1 12h-2.9"></path><path d="M22.8 12h-2.9"></path><path d="m17 17 2-2"></path><path d="m7 7-2 2"></path></svg>
                                            <p class="text-lg font-bold text-white">${percentuale}%</p>
                                        </div>
                                    </div>
                                    ${setNoteHtml}
                                </div>
                            `;
                        });
                    } else { setsHtml += `<p class="text-slate-400">Dettagli serie non disponibili.</p>`; }
                    setsHtml += '</div>';
                    exerciseList.innerHTML += `
                        <div class="flex flex-col sm:flex-row items-start gap-4 p-4 bg-slate-800 rounded-lg">
                            <img src="${imageUrl}" alt="${nomeEsercizio}" class="w-16 h-16 rounded-md object-cover flex-shrink-0 cursor-pointer enlargeable-image sm:mt-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';">
                            <div class="flex-grow w-full">
                                ${infoHtml}
                                ${setsHtml}
                            </div>
                        </div>
                    `;
                });
            } else { exerciseList.innerHTML = `<p class="text-slate-400">Nessun esercizio in questa scheda.</p>`; }
            content.appendChild(exerciseList);
            details.appendChild(summary);
            details.appendChild(content);
            return details;
        }
        
        // --- Funzione createCircuitElement (invariata) ---
        function createCircuitElement(circuito, eserciziMap) {
            const details = document.createElement('details');
            details.className = 'plan-card bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg overflow-hidden';
            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-4 md:p-6';
            summary.innerHTML = `
                <h3 class="text-xl font-bold text-white">${circuito.nomeCircuito}</h3>
                <div class="icon text-purple-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            `;
            const content = document.createElement('div');
            content.className = 'p-4 md:p-6 border-t border-slate-700/50';
            const timingInfo = document.createElement('div');
            timingInfo.className = 'flex gap-4 mb-4 p-3 bg-slate-800 rounded-lg';
            timingInfo.innerHTML = `
                <div class="flex-1 text-center">
                    <p class="text-sm font-medium text-slate-400">LAVORO</p>
                    <p class="text-xl font-bold text-white">${circuito.tempoLavoro || 'N/A'}</p>
                </div>
                <div class="flex-1 text-center border-l border-slate-600">
                    <p class="text-sm font-medium text-slate-400">RECUPERO</p>
                    <p class="text-xl font-bold text-white">${circuito.tempoRecupero || 'N/A'}</p>
                </div>
            `;
            content.appendChild(timingInfo);
            const exerciseList = document.createElement('div');
            exerciseList.className = 'space-y-4';
            if (circuito.esercizi && circuito.esercizi.length > 0) {
                const orderedExercises = (circuito.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                orderedExercises.forEach(esercizio => {
                    if (!esercizio.esercizioId) return; // Salta se manca id
                    const fullEsercizio = eserciziMap.get(esercizio.esercizioId);
                    const imageUrl = fullEsercizio?.imageUrl || 'https://placehold.co/100x100/334155/e2e8f0?text=IMG';
                    const nomeEsercizio = esercizio.nome || fullEsercizio?.nome || 'Esercizio Sconosciuto';
                    const notaGeneraleEsercizio = fullEsercizio?.note || '';
                    const pesoHtml = `Peso: <span class="font-bold text-white">${esercizio.peso || 'N/A'}</span>`;
                    const noteHtml = esercizio.note ? `<p class="text-sm text-amber-300/80 mt-1 italic">Nota: ${esercizio.note}</p>` : '';
                    const notaGeneraleHtml = notaGeneraleEsercizio ? `<p class="text-sm text-slate-400 italic mt-1">${notaGeneraleEsercizio}</p>` : '';
                    exerciseList.innerHTML += `
                        <div class="flex flex-col sm:flex-row items-start gap-4 p-4 bg-slate-800 rounded-lg">
                            <img src="${imageUrl}" alt="${nomeEsercizio}" class="w-16 h-16 rounded-md object-cover flex-shrink-0 cursor-pointer enlargeable-image sm:mt-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';">
                            <div class="flex-grow w-full">
                                <p class="font-bold text-lg text-purple-300">${nomeEsercizio}</p>
                                ${notaGeneraleHtml}
                                <div class="mt-3 bg-slate-700/50 p-3 rounded-lg">
                                    <p class="text-slate-300 font-mono text-sm">${pesoHtml}</p>
                                    ${noteHtml}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else { exerciseList.innerHTML = `<p class="text-slate-400">Nessun esercizio in questo circuito.</p>`; }
            content.appendChild(exerciseList);
            details.appendChild(summary);
            details.appendChild(content);
            return details;
        }

        // --- GESTIONE LIGHTBOX IMMAGINE (invariata) ---
        function openImageLightbox(src) {
            lightboxImage.src = src;
            imageLightbox.classList.remove('hidden');
            setTimeout(() => imageLightbox.classList.remove('opacity-0'), 10);
        }
        function closeImageLightbox() {
            imageLightbox.classList.add('opacity-0');
            setTimeout(() => {
                imageLightbox.classList.add('hidden');
                lightboxImage.src = '';
            }, 300);
        }
        mainContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('enlargeable-image')) {
                openImageLightbox(e.target.src);
            }
        });
        closeLightboxBtn.addEventListener('click', closeImageLightbox);
        imageLightbox.addEventListener('click', (e) => {
            if (e.target === imageLightbox) { 
                closeImageLightbox();
            }
        });
        
        // --- GESTIONE TAB (invariata) ---
        function switchTab(tab) {
            if (tab === 'schede') {
                schedeContent.classList.add('active');
                circuitiContent.classList.remove('active');
                tabBtnSchede.classList.add('active');
                tabBtnCircuiti.classList.remove('active');
            } else if (tab === 'circuiti') {
                schedeContent.classList.remove('active');
                circuitiContent.classList.add('active');
                tabBtnSchede.classList.remove('active');
                tabBtnCircuiti.classList.add('active');
            }
        }
        tabBtnSchede.addEventListener('click', () => switchTab('schede'));
        tabBtnCircuiti.addEventListener('click', () => switchTab('circuiti'));

    </script>
</body>
</html>
