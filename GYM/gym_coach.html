<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym - Coach View & Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        
        /* Accordion */
        .plan-card summary { cursor: pointer; outline: none; list-style: none; }
        .plan-card[open] summary { border-bottom: 1px solid #334155; }
        .plan-card summary::-webkit-details-marker { display: none; }
        .plan-card summary .icon { transition: transform 0.2s; }
        .plan-card[open] summary .icon { transform: rotate(90deg); }
        
        /* Tabs */
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; font-weight: 600; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: #e2e8f0; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Utils */
        #image-lightbox { transition: opacity 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .close-btn-hover:hover { transform: scale(1.1) rotate(90deg); }
    </style>
     <script type="module" src="../auth-manager-coach.js"></script>
</head>
<body class="antialiased" style="visibility: hidden;">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div id="loader-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col justify-center items-center z-50">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-t-4 border-slate-600 border-t-sky-500"></div>
        <p class="mt-4 text-slate-300">Caricamento dati...</p>
    </div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <header class="mb-10 border-b border-slate-700 pb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black text-slate-100">Gym Coach</h1>
                    <p id="welcome-message" class="text-lg text-sky-400 font-semibold">Visualizzazione Schede e Circuiti</p>
                </div>
                <a href="../coach_home.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    Home
                </a>
            </div>
        </header>

        <main id="main-content" class="hidden">
            <div class="mb-6 flex border-b border-slate-700">
                <button id="tab-btn-schede" class="tab-btn active" data-tab="schede">Schede</button>
                <button id="tab-btn-circuiti" class="tab-btn" data-tab="circuiti">Circuiti</button>
            </div>

            <div id="schede-content" class="tab-content active">
                <h2 class="text-2xl font-bold text-white mb-6">Schede di Allenamento</h2>
                <div id="plans-container" class="space-y-6"></div>
                <div id="no-schede-message" class="hidden text-center py-16 px-6 bg-slate-900/70 border border-slate-700/50 rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-slate-500"><rect x="3" y="10" width="4" height="4" rx="1"/><rect x="17" y="10" width="4" height="4" rx="1"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
                    <h3 class="text-xl font-bold text-white">Nessuna scheda trovata</h3>
                    <p class="text-slate-400 mt-2">Non ci sono ancora schede di allenamento disponibili.</p>
                </div>
            </div>

            <div id="circuiti-content" class="tab-content">
                <h2 class="text-2xl font-bold text-white mb-6">Circuiti</h2>
                <div id="circuits-container" class="space-y-6"></div>
                <div id="no-circuits-message" class="hidden text-center py-16 px-6 bg-slate-900/70 border border-slate-700/50 rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-slate-500"><path d="M12 2.8c.9-.1 1.8.2 2.5.8 1.1 1 1.5 2.5 1 4L12 18 8.5 7.5c-.5-1.4 0-3 1-4 .8-.5 1.7-.8 2.5-.7z"/><path d="M12 18c-1.9 0-3.5-1-4.5-2.5s-1.5-3.5-1-5.5c.3-1.1.8-2.1 1.5-3M12 18c1.9 0 3.5-1 4.5-2.5s1.5-3.5 1-5.5c-.3-1.1-.8-2.1-1.5-3"/></svg>
                    <h3 class="text-xl font-bold text-white">Nessun circuito trovato</h3>
                    <p class="text-slate-400 mt-2">Non ci sono ancora circuiti disponibili.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="image-lightbox" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 opacity-0">
        <div class="relative max-w-3xl max-h-full">
            <img id="lightbox-image" src="" alt="Esercizio ingrandito" class="block max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl">
            <button id="close-lightbox" class="absolute -top-2 -right-2 bg-white text-slate-900 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xl leading-none">&times;</button>
        </div>
    </div>

    <div id="circuit-timer-overlay" class="fixed inset-0 bg-slate-900 z-[9000] hidden flex flex-col">
        <button id="close-timer" class="fixed top-4 right-4 z-[10000] bg-red-600 hover:bg-red-500 text-white w-12 h-12 rounded-full flex items-center justify-center font-bold text-2xl shadow-xl border-2 border-white/20 transition-all close-btn-hover cursor-pointer">
            &times;
        </button>

        <div class="flex-1 flex flex-col landscape:flex-row h-full overflow-hidden">
            
            <div id="timer-bg-panel" class="w-full h-1/2 landscape:w-1/2 landscape:h-full flex flex-col justify-center items-center bg-slate-900 transition-colors duration-500 relative border-b landscape:border-b-0 landscape:border-r border-slate-700 shadow-xl z-10 order-1">
                <p id="timer-phase-text" class="text-2xl font-black tracking-[0.3em] uppercase mb-2 text-slate-400 opacity-80">PRONTO</p>
                <div class="relative">
                    <div class="text-[7rem] md:text-[9rem] landscape:text-[11rem] font-black text-white leading-none select-none tabular-nums drop-shadow-2xl" id="timer-countdown">00</div>
                </div>
                <div class="flex gap-6 mt-6">
                    <button id="timer-toggle-btn" class="bg-emerald-500 hover:bg-emerald-400 text-white rounded-full h-20 w-20 flex items-center justify-center shadow-lg shadow-emerald-900/50 transform active:scale-95 transition-all border-4 border-emerald-600/30">
                        <span id="btn-icon-play" class="text-3xl">▶</span>
                    </button>
                    <button id="timer-skip-btn" class="bg-slate-700 hover:bg-slate-600 text-white rounded-full h-20 w-20 flex items-center justify-center shadow-lg transform active:scale-95 transition-all border-4 border-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13 17 5-5-5-5"/><path d="m6 17 5-5-5-5"/></svg>
                    </button>
                </div>
            </div>

            <div class="w-full h-1/2 landscape:w-1/2 landscape:h-full flex flex-col bg-slate-800 relative p-4 pb-8 order-2">
                <div class="shrink-0 mb-3 text-center">
                    <h3 id="timer-exercise-name" class="text-2xl md:text-4xl font-black text-white leading-tight drop-shadow-lg uppercase truncate px-2">Caricamento...</h3>
                    <p id="timer-exercise-note" class="text-sky-300 text-base md:text-lg font-medium italic mt-1 text-center truncate px-4"></p>
                </div>
                <div class="flex-1 relative w-full overflow-hidden rounded-xl bg-black/50 shadow-inner border border-slate-600/50 min-h-0">
                    <img id="timer-exercise-img" src="" class="absolute inset-0 w-full h-full object-contain" alt="Esercizio">
                </div>
                <div class="shrink-0 pt-3 text-center">
                    <p class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">PROSSIMO ESERCIZIO</p>
                    <p id="timer-next-name" class="text-slate-300 font-bold text-sm truncate">...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from "../auth-manager-coach.js";
        import { collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- ELEMENTI DOM PRINCIPALI ---
        const loader = document.getElementById('loader-overlay');
        const mainContent = document.getElementById('main-content');
        const welcomeMessage = document.getElementById('welcome-message');
        const plansContainer = document.getElementById('plans-container');
        const noSchedeMessage = document.getElementById('no-schede-message');
        const imageLightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const closeLightboxBtn = document.getElementById('close-lightbox');
        
        const tabBtnSchede = document.getElementById('tab-btn-schede');
        const tabBtnCircuiti = document.getElementById('tab-btn-circuiti');
        const schedeContent = document.getElementById('schede-content');
        const circuitiContent = document.getElementById('circuiti-content');
        const circuitsContainer = document.getElementById('circuits-container');
        const noCircuitsMessage = document.getElementById('no-circuits-message');

        // --- ELEMENTI TIMER (AGGIUNTI) ---
        const timerOverlay = document.getElementById('circuit-timer-overlay');
        const closeTimerBtn = document.getElementById('close-timer');
        const timerExerciseName = document.getElementById('timer-exercise-name');
        const timerExerciseImg = document.getElementById('timer-exercise-img');
        const timerExerciseNote = document.getElementById('timer-exercise-note');
        const timerNextName = document.getElementById('timer-next-name');
        const timerCountdown = document.getElementById('timer-countdown');
        const timerPhaseText = document.getElementById('timer-phase-text');
        const timerBgPanel = document.getElementById('timer-bg-panel');
        const btnIconPlay = document.getElementById('btn-icon-play');
        const timerToggleBtn = document.getElementById('timer-toggle-btn');
        const timerSkipBtn = document.getElementById('timer-skip-btn');

        // --- STATO TIMER ---
        let currentCircuitData = null;
        let currentExerciseIndex = 0;
        let isWorkPhase = true;
        let timeLeft = 0;
        let timerInterval = null;
        let isRunning = false;
        let audioCtx = null;
        
        // --- AUTH ---
        document.addEventListener('coachAuthStateReady', (e) => {
            const { coach, error } = e.detail;
            if (coach) {
                document.body.style.visibility = 'visible';
                welcomeMessage.textContent = `Benvenuto, ${coach.cognome || 'Coach'}`;
                loadGymData();
            } else {
                console.log("Auth fallita, redirect in corso...");
            }
        });
        
        async function loadGymData() {
            try {
                const massimaliMap = new Map();
                const eserciziMap = new Map();
                const eserciziQuery = query(collection(db, "esercizi_pesistica"));
                const eserciziSnapshot = await getDocs(eserciziQuery);
                eserciziSnapshot.forEach(doc => {
                    eserciziMap.set(doc.id, doc.data());
                });

                const schedeQuery = query(collection(db, "schede_pesistica"));
                const circuitiQuery = query(collection(db, "circuiti_pesistica"));

                const [schedeSnapshot, circuitiSnapshot] = await Promise.all([
                    getDocs(schedeQuery),
                    getDocs(circuitiQuery)
                ]);

                if (schedeSnapshot.empty) {
                    noSchedeMessage.classList.remove('hidden');
                } else {
                    plansContainer.innerHTML = '';
                    const schede = schedeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    schede.sort((a, b) => a.nomeScheda.localeCompare(b.nomeScheda));
                    schede.forEach(scheda => {
                        const planElement = createPlanElement(scheda, massimaliMap, eserciziMap);
                        plansContainer.appendChild(planElement);
                    });
                    noSchedeMessage.classList.add('hidden');
                }

                if (circuitiSnapshot.empty) {
                    noCircuitsMessage.classList.remove('hidden');
                } else {
                    circuitsContainer.innerHTML = '';
                    const circuiti = circuitiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    circuiti.sort((a, b) => a.nomeCircuito.localeCompare(b.nomeCircuito));
                    circuiti.forEach(circuito => {
                        const circuitElement = createCircuitElement(circuito, eserciziMap);
                        circuitsContainer.appendChild(circuitElement);
                    });
                    noCircuitsMessage.classList.add('hidden');
                }

            } catch (error) {
                console.error("Errore nel caricamento dei dati: ", error);
            } finally {
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        // --- SCHEDE (Invariato) ---
        function createPlanElement(scheda, massimaliMap, eserciziMap) {
            const details = document.createElement('details');
            details.className = 'plan-card bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg overflow-hidden';
            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-4 md:p-6';
            summary.innerHTML = `<h3 class="text-xl font-bold text-white">${scheda.nomeScheda}</h3><div class="icon text-sky-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>`;
            const content = document.createElement('div');
            content.className = 'p-4 md:p-6 border-t border-slate-700/50';
            const exerciseList = document.createElement('div');
            exerciseList.className = 'space-y-4';

            if (scheda.esercizi && scheda.esercizi.length > 0) {
                 const orderedExercises = (scheda.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                orderedExercises.forEach(esercizio => {
                    if (!esercizio.esercizioId) return;
                    const fullEsercizio = eserciziMap.get(esercizio.esercizioId);
                    const imageUrl = fullEsercizio?.imageUrl || 'https://placehold.co/100x100/334155/e2e8f0?text=IMG';
                    const nomeEsercizio = esercizio.nome || fullEsercizio?.nome || 'Esercizio Sconosciuto';
                    const notaGeneraleEsercizio = fullEsercizio?.note || '';
                    const tipoSerie = esercizio.tipo || 'fisse';
                    const infoHtml = `<p class="font-bold text-lg text-slate-100">${nomeEsercizio}</p>${notaGeneraleEsercizio ? `<p class="text-sm text-slate-400 italic mt-1">${notaGeneraleEsercizio}</p>` : ''}<p class="text-sm font-medium text-indigo-300 mt-2">Tipo: <span class="font-normal capitalize text-slate-300">${tipoSerie}</span></p>`;
                    let setsHtml = '<div class="space-y-3 mt-3">';
                    if (esercizio.sets && esercizio.sets.length > 0) {
                        esercizio.sets.forEach(set => {
                            const percentuale = set.percentuale || '-';
                            const setNoteHtml = set.note ? `<p class="text-xs text-amber-300/80 mt-1 italic pl-2">Nota: ${set.note}</p>` : '';
                            setsHtml += `<div class="bg-slate-700/50 p-3 rounded-lg"><div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2"><p class="text-slate-300 font-mono text-sm"><span class="font-bold text-white">${set.serie || '-'}</span> x <span class="font-bold text-white">${set.ripetizioni || '-'}</span></p><div class="flex items-center gap-2 bg-slate-800 p-2 rounded-lg flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12v0Z"></path><path d="M12 13.4a1.4 1.4 0 1 0 0-2.8 1.4 1.4 0 0 0 0 2.8Z"></path></svg><p class="text-lg font-bold text-white">${percentuale}%</p></div></div>${setNoteHtml}</div>`;
                        });
                    } else { setsHtml += `<p class="text-slate-400">Dettagli serie non disponibili.</p>`; }
                    setsHtml += '</div>';
                    exerciseList.innerHTML += `<div class="flex flex-col sm:flex-row items-start gap-4 p-4 bg-slate-800 rounded-lg"><img src="${imageUrl}" class="w-16 h-16 rounded-md object-cover flex-shrink-0 cursor-pointer enlargeable-image sm:mt-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';"><div class="flex-grow w-full">${infoHtml}${setsHtml}</div></div>`;
                });
            } else { exerciseList.innerHTML = `<p class="text-slate-400">Nessun esercizio in questa scheda.</p>`; }
            content.appendChild(exerciseList); details.appendChild(summary); details.appendChild(content); return details;
        }
        
        // --- CIRCUITI (MODIFICATO PER TIMER) ---
        function createCircuitElement(circuito, eserciziMap) {
            const details = document.createElement('details');
            details.className = 'plan-card bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg overflow-hidden';
            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-4 md:p-6';
            summary.innerHTML = `<h3 class="text-xl font-bold text-white">${circuito.nomeCircuito}</h3><div class="icon text-purple-400"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>`;
            const content = document.createElement('div');
            content.className = 'p-4 md:p-6 border-t border-slate-700/50';
            
            // Info Timing + Pulsante Start
            content.innerHTML = `
                <div class="flex gap-4 mb-4 p-3 bg-slate-800 rounded-lg">
                    <div class="flex-1 text-center"><p class="text-sm font-medium text-slate-400">LAVORO</p><p class="text-xl font-bold text-white">${circuito.tempoLavoro || 'N/A'}</p></div>
                    <div class="flex-1 text-center border-l border-slate-600"><p class="text-sm font-medium text-slate-400">RECUPERO</p><p class="text-xl font-bold text-white">${circuito.tempoRecupero || 'N/A'}</p></div>
                </div>
            `;

            // Pulsante AVVIA TIMER
            const btn = document.createElement('button');
            btn.className = "w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg shadow-lg mb-4 flex items-center justify-center gap-2 transition-transform active:scale-95";
            btn.innerHTML = `<span class="text-xl">▶</span> <span class="text-lg">AVVIA TIMER</span>`;
            
            btn.onclick = function(e) {
                e.preventDefault(); e.stopPropagation();
                if (!circuito.esercizi || circuito.esercizi.length === 0) return alert("ERRORE: Circuito senza esercizi!");
                try { openTimer(circuito, eserciziMap); } catch (err) { alert("Errore Timer: " + err.message); }
            };
            content.appendChild(btn);

            // Lista Esercizi
            const exerciseList = document.createElement('div');
            exerciseList.className = 'space-y-4';
            if (circuito.esercizi && circuito.esercizi.length > 0) {
                const orderedExercises = (circuito.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
                orderedExercises.forEach(esercizio => {
                    const fullEsercizio = eserciziMap.get(esercizio.esercizioId);
                    const imageUrl = fullEsercizio?.imageUrl || 'https://placehold.co/100x100/334155/e2e8f0?text=IMG';
                    const nomeEsercizio = esercizio.nome || fullEsercizio?.nome || 'Esercizio Sconosciuto';
                    const notaGeneraleEsercizio = fullEsercizio?.note || '';
                    const pesoHtml = `Peso: <span class="font-bold text-white">${esercizio.peso || 'N/A'}</span>`;
                    const noteHtml = esercizio.note ? `<p class="text-sm text-amber-300/80 mt-1 italic">Nota: ${esercizio.note}</p>` : '';
                    const notaGeneraleHtml = notaGeneraleEsercizio ? `<p class="text-sm text-slate-400 italic mt-1">${notaGeneraleEsercizio}</p>` : '';
                    exerciseList.innerHTML += `<div class="flex flex-col sm:flex-row items-start gap-4 p-4 bg-slate-800 rounded-lg"><img src="${imageUrl}" alt="${nomeEsercizio}" class="w-16 h-16 rounded-md object-cover flex-shrink-0 cursor-pointer enlargeable-image sm:mt-1" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';"><div class="flex-grow w-full"><p class="font-bold text-lg text-purple-300">${nomeEsercizio}</p>${notaGeneraleHtml}<div class="mt-3 bg-slate-700/50 p-3 rounded-lg"><p class="text-slate-300 font-mono text-sm">${pesoHtml}</p>${noteHtml}</div></div></div>`;
                });
            } else { exerciseList.innerHTML = `<p class="text-slate-400">Nessun esercizio in questo circuito.</p>`; }
            content.appendChild(exerciseList);
            details.appendChild(summary); details.appendChild(content);
            return details;
        }

        // --- TIMER LOGIC (Copiata dalla versione Athlete) ---
        function parseTime(val) {
            if (!val) return 0;
            let s = String(val).replace(/[^0-9:]/g, ''); 
            if (s.includes(':')) {
                const parts = s.split(':');
                return (parseInt(parts[0])*60) + parseInt(parts[1]);
            }
            return parseInt(s) || 0;
        }

        function openTimer(circuito, eserciziMap) {
            const workSec = parseTime(circuito.tempoLavoro);
            const restSec = parseTime(circuito.tempoRecupero);
            const exercises = (circuito.esercizi || []).sort((a,b)=>a.ordine-b.ordine).map(ex => {
                const info = eserciziMap.get(ex.esercizioId);
                return {
                    name: info?.nome || ex.nome || "Esercizio",
                    img: info?.imageUrl || "https://placehold.co/600x400?text=No+Img",
                    note: ex.peso ? `Peso: ${ex.peso}` : (ex.note || info?.note || ""),
                    work: workSec || 30, rest: restSec || 10
                };
            });
            currentCircuitData = exercises; currentExerciseIndex = 0; isWorkPhase = true; timeLeft = exercises[0].work; isRunning = false;
            updateUI();
            
            // Show Overlay
            timerOverlay.style.display = ''; 
            timerOverlay.classList.remove('hidden'); 
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>console.log(e));
        }

        function updateUI() {
            const ex = currentCircuitData[currentExerciseIndex];
            const next = currentCircuitData[(currentExerciseIndex+1) % currentCircuitData.length];
            timerExerciseName.textContent = ex.name; timerExerciseImg.src = ex.img; timerExerciseNote.textContent = ex.note; timerNextName.textContent = next.name;

            if (isWorkPhase) {
                timerBgPanel.classList.remove('bg-amber-900'); timerBgPanel.classList.add('bg-emerald-900');
                timerPhaseText.textContent = "LAVORO"; timerPhaseText.classList.replace("text-amber-400", "text-emerald-400");
                timerToggleBtn.className = "bg-emerald-500 hover:bg-emerald-400 text-white rounded-full h-20 w-20 flex items-center justify-center shadow-lg shadow-emerald-900/50 transform active:scale-95 transition-all border-4 border-emerald-600/30";
            } else {
                timerBgPanel.classList.remove('bg-emerald-900'); timerBgPanel.classList.add('bg-amber-900');
                timerPhaseText.textContent = "RECUPERO"; timerPhaseText.classList.replace("text-emerald-400", "text-amber-400");
                timerToggleBtn.className = "bg-amber-600 hover:bg-amber-500 text-white rounded-full h-20 w-20 flex items-center justify-center shadow-lg transform active:scale-95 transition-all border-4 border-amber-600/30";
            }
            timerCountdown.textContent = timeLeft < 10 ? `0${timeLeft}` : timeLeft;
            btnIconPlay.innerHTML = isRunning ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
        }

        function tick() {
            const currentTotalTime = isWorkPhase ? currentCircuitData[currentExerciseIndex].work : currentCircuitData[currentExerciseIndex].rest;
            if (currentTotalTime > 10 && timeLeft === Math.floor(currentTotalTime / 2)) playWarning();
            if (currentTotalTime > 20 && timeLeft === 15) playWarning();
            if (timeLeft > 0 && timeLeft <= 3) playTick();
            
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(timerInterval); playBell();
                if (isWorkPhase) { isWorkPhase = false; timeLeft = currentCircuitData[currentExerciseIndex].rest; } 
                else { isWorkPhase = true; currentExerciseIndex = (currentExerciseIndex + 1) % currentCircuitData.length; timeLeft = currentCircuitData[currentExerciseIndex].work; if(currentExerciseIndex===0) alert("Giro completato!"); }
                updateUI(); timerInterval = setInterval(tick, 1000);
            } else {
                timerCountdown.textContent = timeLeft < 10 ? `0${timeLeft}` : timeLeft;
            }
        }

        function toggleTimer() {
            if (isRunning) { clearInterval(timerInterval); isRunning = false; } 
            else { if(!audioCtx) playTick(); timerInterval = setInterval(tick, 1000); isRunning = true; }
            updateUI();
        }

        // --- AUDIO FUNCTIONS ---
        function playBell() { try{ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g),g.connect(audioCtx.destination),o.frequency.setValueAtTime(523.25,t),g.gain.setValueAtTime(.3,t),g.gain.exponentialRampToValueAtTime(.001,t+1.5),o.start(t),o.stop(t+1.5);const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2),g2.connect(audioCtx.destination),o2.frequency.setValueAtTime(1046.5,t),g2.gain.setValueAtTime(.1,t),g2.gain.exponentialRampToValueAtTime(.001,t+1),o2.start(t),o2.stop(t+1)}catch(e){} }
        function playTick() { try{ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g),g.connect(audioCtx.destination),o.type="square",o.frequency.setValueAtTime(800,t),g.gain.setValueAtTime(.05,t),g.gain.exponentialRampToValueAtTime(.001,t+.05),o.start(t),o.stop(t+.1)}catch(e){} }
        function playWarning() { try{ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g),g.connect(audioCtx.destination),o.type="sine",o.frequency.setValueAtTime(1200,t),g.gain.setValueAtTime(.1,t),g.gain.exponentialRampToValueAtTime(.001,t+.1),o.start(t),o.stop(t+.1);const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2),g2.connect(audioCtx.destination),o2.type="sine",o2.frequency.setValueAtTime(1200,t+.15),g2.gain.setValueAtTime(.1,t+.15),g2.gain.exponentialRampToValueAtTime(.001,t+.25),o2.start(t+.15),o2.stop(t+.25)}catch(e){} }

        // --- EVENT LISTENERS ---
        timerToggleBtn.onclick = toggleTimer;
        timerSkipBtn.onclick = () => { timeLeft=0; tick(); };
        
        closeTimerBtn.onclick = () => { 
            clearInterval(timerInterval); 
            isRunning = false; 
            timerOverlay.classList.add('hidden'); 
            timerOverlay.style.display = 'none'; 
        };

        function openImageLightbox(src) { lightboxImage.src = src; imageLightbox.classList.remove('hidden'); setTimeout(() => imageLightbox.classList.remove('opacity-0'), 10); }
        function closeImageLightbox() { imageLightbox.classList.add('opacity-0'); setTimeout(() => { imageLightbox.classList.add('hidden'); lightboxImage.src = ''; }, 300); }
        mainContent.addEventListener('click', (e) => { if (e.target.classList.contains('enlargeable-image')) openImageLightbox(e.target.src); });
        closeLightboxBtn.addEventListener('click', closeImageLightbox);
        imageLightbox.addEventListener('click', (e) => { if (e.target === imageLightbox) closeImageLightbox(); });

        function switchTab(tab) {
            if (tab === 'schede') { schedeContent.classList.add('active'); circuitiContent.classList.remove('active'); tabBtnSchede.classList.add('active'); tabBtnCircuiti.classList.remove('active'); } 
            else if (tab === 'circuiti') { schedeContent.classList.remove('active'); circuitiContent.classList.add('active'); tabBtnSchede.classList.remove('active'); tabBtnCircuiti.classList.add('active'); }
        }
        tabBtnSchede.addEventListener('click', () => switchTab('schede'));
        tabBtnCircuiti.addEventListener('click', () => switchTab('circuiti'));

    </script>
</body>
</html>
